// Copyright (c) 2017, WNProject Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE.txt file.

struct Foo {
  Int x = 3;
}

// RUN shared1 3 -> 3
// RUN shared1 4 -> 3
// CHECK: {{7shared1E}}
Int shared1(Int x) {
// CHECK-NEXT: Foo* f = (Foo*)_Z3wns14_assign_sharedEvpvpvp((void*)_Z3wns14_construct_FooENR3FooENUC3FooE((Foo*)_Z3wns16_allocate_sharedEvpsfp(sizeof(Foo), &_Z3wns13_destruct_FooEvNUC3FooE)), NULL);
  shared Foo f = shared Foo();
// CHECK: int32_t __wns_ret_temp0 = f->x;
// CHECK-NEXT: _Z3wns13_deref_sharedEvvp((void*)f);
// CHECK-NEXT: return __wns_ret_temp0;
  return f.x;
}

// RUN shared2 3 -> 3
// RUN shared2 12 -> 12
// RUN shared2 -42 -> -42
// CHECK: {{7shared2E}}
Int shared2(Int x) {
  shared Foo f = shared Foo();
// CHECK: f->x = x;
  f.x = x;
  return f.x;
}

// RUN shared3 -> 3
// CHECK: {{7shared3E}}
Int shared3() {
// CHECK-NEXT: Foo* __wns_temp_expression0 = (Foo*)_Z3wns14_assign_sharedEvpvpvp((void*)_Z3wns14_construct_FooENR3FooENUC3FooE((Foo*)_Z3wns16_allocate_sharedEvpsfp(sizeof(Foo), &_Z3wns13_destruct_FooEvNUC3FooE)), NULL);
// CHECK-NEXT: {
// CHECK-NEXT: int32_t __wns_ret_temp2 = __wns_temp_expression0->x;
// CHECK-NEXT: _Z3wns13_deref_sharedEvvp((void*)__wns_temp_expression0);
// CHECK-NEXT: return __wns_ret_temp2;
  return (shared Foo()).x;
}

// RUN: shared4 32 -> 3
// RUN: shared4 12 -> 3
// CHECK: {{7shared4E}}
Int shared4(Int x) {
// CHECK: Foo* f = (Foo*)_Z3wns14_assign_sharedEvpvpvp((void*)_Z3wns14_construct_FooENR3FooENUC3FooE((Foo*)_Z3wns16_allocate_sharedEvpsfp(sizeof(Foo), &_Z3wns13_destruct_FooEvNUC3FooE)), NULL);
  shared Foo f = shared Foo();
// CHECK: f->x = x;
  f.x = x;
// CHECK: f = (Foo*)_Z3wns14_assign_sharedEvpvpvp((void*)_Z3wns14_construct_FooENR3FooENUC3FooE((Foo*)_Z3wns16_allocate_sharedEvpsfp(sizeof(Foo), &_Z3wns13_destruct_FooEvNUC3FooE)), (void*)f);
  f = shared Foo();
  return f.x;
}

// CHECK: {{14shared_helper1E}}
shared Foo shared_helper1() {
// CHECK-NEXT: return _Z3wns14_construct_FooENR3FooENUC3FooE((Foo*)_Z3wns16_allocate_sharedEvpsfp(sizeof(Foo), &_Z3wns13_destruct_FooEvNUC3FooE));
  return shared Foo();
}

// RUN shared5 -> 3
// CHECK: {{7shared5E}}
Int shared5() {
  shared Foo f = shared_helper1();
  // CHECK-NEXT: Foo* f = (Foo*)_Z3wns14_assign_sharedEvpvpvp((void*)_Z3wns14shared_helper1ENRR3FooE(), NULL);
  return f.x;
}


// CHECK: {{14shared_helper2E}}
shared Foo shared_helper2() {
  shared Foo f = shared Foo();
  f.x = 32;
// CHECK: return (Foo*)_Z3wns14_return_sharedEvpvp((void*)__wns_ret_temp5);
  return f;
}

// RUN: shared6 -> 32
// CHECK: {{7shared6E}}
Int shared6() {
  shared Foo f = shared_helper2();
  return f.x;
}